const fs = require('fs')

const PE = require('portable-executable')

const malwareDirectory = "./Malware"
const cleanFileDirectory = "./CleanFiles"

const getDLLPath = "./goComp/PEDLLParser/dll"
const getEntropyPath = "./goComp/EntropyUtil/EntropyUtil"
const getFileSize = "./goComp/getFileSize/getFileSize"
const getFileFunctions = "python ./dllFunctionCallParser/analysePE.py"


const createCsvWriter = require('csv-writer').createObjectCsvWriter;

const execSync = require('child_process').execSync



let malwareFiles = []
let malwareFilesData = []

let cleanFiles = []
let cleanFileData = []

let allData = []

const main = () => {

    // console.log(DLLData)

    /*
        Getting Features
    */
    fs.readdirSync(malwareDirectory).forEach(file => {
        //set filepath
        let filePath = `./${malwareDirectory}/${file}`

        malwareFiles.push(file)
        let dataObj = {}

        dataObj['file'] = file
        dataObj['Malicous'] = 1

        // console.log(file)
        try {
            let data = execSync(`${getDLLPath} ${filePath}`, { encoding: 'utf8', maxBuffer: 50 * 1024 * 1024 })
            let pdata = data.split(/\r?\n/)
            pdata = pdata.filter(item => item);
            dataObj['DLL'] = pdata
            dataObj['numDLLS'] = pdata.length
        }
        catch (e) {
            dataObj['DLL'] = 'error'
            dataObj['numDLLS'] = 0

        }

        //get entropy
        try {
            let data = execSync(`${getEntropyPath} ./${malwareDirectory}/${file}`, { encoding: 'utf8', maxBuffer: 50 * 1024 * 1024 })
            dataObj['entropy'] = parseInt(data.split(/\r?\n/))

        }
        catch (e) {
            // console.log(`can't open: ${e}`)
            dataObj['entropy'] = 0

        }

        //get file size
        try {
            let data = execSync(`${getFileSize} ./${malwareDirectory}/${file}`, { encoding: 'utf8', maxBuffer: 50 * 1024 * 1024 })
            dataObj['fileSize'] = parseInt(data.split(/\r?\n/))

        }
        catch (e) {
            // console.log(`can't open: ${e}`)
            dataObj['fileSize'] = 0

        }

        // //get other PE Data
        // try {
        //     let pe = PE.PortableExecutable(fs.readFileSync(filePath))
        //     console.log(JSON.stringify(pe))
        // }
        // catch (e) {
        //     console.log(e)
        // }

        malwareFilesData.push(dataObj)
        allData.push(dataObj)
    });

    fs.readdirSync(cleanFileDirectory).forEach(file => {
        let filePath = `./${cleanFileDirectory}/${file}`

        cleanFiles.push(file)
        let dataObj = {}
        // console.log(file)
        dataObj['file'] = file
        dataObj['Malicous'] = 0

        try {
            let data = execSync(`${getDLLPath} ${filePath}`, { encoding: 'utf8', maxBuffer: 50 * 1024 * 1024 })
            let pdata = data.split(/\r?\n/)
            pdata = pdata.filter(item => item);
            dataObj['DLL'] = pdata
            dataObj['numDLLS'] = pdata.length
        }
        catch (e) {
            // console.log(`can't open: ${e}`)
            // malwareFilesData.push('error')
            dataObj['DLL'] = 'error'
            dataObj['numDLLS'] = 0


        }

        //get entropy
        try {
            let data = execSync(`${getEntropyPath} ./${cleanFileDirectory}/${file}`, { encoding: 'utf8', maxBuffer: 50 * 1024 * 1024 })
            dataObj['entropy'] = parseInt(data.split(/\r?\n/))

        }
        catch (e) {
            // console.log(`can't open: ${e}`)
            dataObj['entropy'] = 0

        }

        //get file size
        try {
            let data = execSync(`${getFileSize} ./${cleanFileDirectory}/${file}`, { encoding: 'utf8', maxBuffer: 50 * 1024 * 1024 })
            dataObj['fileSize'] = parseInt(data.split(/\r?\n/))

        }
        catch (e) {
            // console.log(`can't open: ${e}`)
            dataObj['fileSize'] = 0

        }

        // //get other PE Data
        // try {
        //     let pe = PE.PortableExecutable(fs.readFileSync(filePath))
        //     console.log(JSON.stringify(pe))
        // }
        // catch (e) {
        //     console.log(e)
        // }


        cleanFileData.push(dataObj)
        allData.push(dataObj)

    });

    //get DLL frequency for features
    // getUniqueDLL()


    for (let i = 0; i < malwareFiles.length; i++) {
        console.log(`${malwareFiles[i]}:${JSON.stringify(malwareFilesData[i], 0, null)}`)
    }

    for (let i = 0; i < cleanFiles.length; i++) {
        console.log(`${cleanFiles[i]}:${JSON.stringify(cleanFileData[i], 0, null)}`)
    }



    let DLLData = JSON.parse(fs.readFileSync('./DLL_DATA.json'))


    console.log(DLLData)

    for (let x = 0; x < allData.length; x++) {
        let file = allData[x]

        for (let i = 0; i < DLLData.DLL_LIST.length; i++) {
            file[DLLData.DLL_LIST[i]] = 0
        }

        for (let b = 0; b < file.DLL.length; b++) {
            if (DLLData.DLL_LIST.includes(file.DLL[b])) {
                file[file.DLL[b]] = 1
            }
        }

    }

    //run all the files through go engine & store output 
    let header = [
        { id: 'file', title: 'File' },
        { id: 'Malicous', title: 'IsMalicous' },
        { id: 'DLL', title: 'DLLs' },
        { id: 'numDLLS', title: 'Number of DLLS' },
        { id: 'entropy', title: 'Entropy' },
        { id: 'fileSize', title: 'File Size' },
    ]
    //set the features
    for (let x = 0; x < DLLData.DLL_LIST.length; x++) {
        header.push(
            {
                id: DLLData.DLL_LIST[x],
                title: DLLData.DLL_LIST[x]
            }
        )
    }
    //create csv of different frequencies
    const csvWriter = createCsvWriter({
        path: 'out.csv',
        header: header

    }); //have to do this dynamically 

    csvWriter.writeRecords(allData).then(() => console.log('The CSV file was written successfully'));


}

const getFreq = (list, matchString) => {
    let count = 0
    list.forEach((dll) => {
        if (matchString == dll) {
            count++
        }
    })

    return count
}

const getUniqueDLL = () => {
    let allDLLS = {
        DLL_LIST: []
    } //to get all DLLS and their frequency
    for (let i = 0; i < allData.length; i++) {
        // console.log(`${cleanFiles[i]}:${JSON.stringify(cleanFileData[i], 0, null)}`) get a list of all DLLS
        try {
            allData[i].DLL.forEach(dll => {
                allDLLS.DLL_LIST.push(dll)
            })
        }
        catch (e) {
            //suppress error because I am lazy
            console.log(e)
        }
    }

    //get frequency 


    //get a unique index 
    uniqueDLLS = allDLLS.DLL_LIST.filter(function (elem, pos) {
        return allDLLS.DLL_LIST.indexOf(elem) == pos;
    })

    uniqueDLLS.forEach((dll) => {
        let freq = getFreq(allDLLS.DLL_LIST, dll)
        allDLLS[dll] = freq
    })

    //adjust the meta list 

    allDLLS.DLL_LIST = uniqueDLLS
    //save the whole list 
    var jsonContent = JSON.stringify(allDLLS);
    console.log(jsonContent);


    fs.writeFile("DLL_DATA.json", jsonContent, 'utf8', function (err) {
        if (err) {
            console.log("An error occured while writing JSON Object to File.");
            return console.log(err);
        }

        console.log("JSON file has been saved.");
    });
}

// const debug = () => {
//     // let filePath =  `./CleanFiles/getscreen.exe`
//     let filePath = `./Malware/0d83906aa1c84a83028cd12f8ef9582a260f94e56c4254cb35735b98d7266b8e.exe`
//     try {
//         console.log('strings')
//         let pe = PE.strings(fs.readFileSync(filePath))
//         console.log(JSON.stringify(pe))

//         console.log('other')
//         pe = PE.PortableExecutable(fs.readFileSync(filePath))
//         console.log(JSON.stringify(pe))
//     }
//     catch (e) {
//         console.log(e)
//     }
// }
// debug()
main()


